<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FinanceAI - Student Financial Advisor</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #FFF5E6;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .chat-container {
      width: 100%;
      max-width: 450px;
      height: 600px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header {
      background: #FF7F7F;
      padding: 20px;
      text-align: center;
      color: white;
      position: relative;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .header p {
      font-size: 0.9rem;
      opacity: 0.9;
      font-weight: 400;
    }

    .status-indicator {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 12px;
      height: 12px;
      background: #4ade80;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #fafafa;
      scroll-behavior: smooth;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .message {
      display: flex;
      margin-bottom: 16px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      justify-content: flex-end;
    }

    .message.bot {
      justify-content: flex-start;
    }

    .message-bubble {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 0.95rem;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .message.user .message-bubble {
      background: #FF7F7F;
      color: white;
      border-bottom-right-radius: 6px;
    }

    .message.bot .message-bubble {
      background: white;
      color: #374151;
      border: 1px solid #e5e7eb;
      border-bottom-left-radius: 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .bot-avatar {
      width: 32px;
      height: 32px;
      background: #FF7F7F;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      margin-top: 4px;
      font-size: 16px;
      flex-shrink: 0;
    }

    .typing-indicator {
      display: none;
      align-items: center;
      margin-bottom: 16px;
    }

    .typing-dots {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 18px;
      border-bottom-left-radius: 6px;
      margin-left: 44px;
    }

    .typing-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9ca3af;
      margin: 0 2px;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .input-area {
      padding: 20px;
      background: white;
      border-top: 1px solid #e5e7eb;
    }

    .input-container {
      display: flex;
      align-items: flex-end;
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      padding: 4px;
      transition: border-color 0.2s ease;
      min-height: 52px;
    }

    .input-container:focus-within {
      border-color: #FF7F7F;
    }

    .message-input {
      flex: 1;
      border: none;
      outline: none;
      padding: 12px 16px;
      font-size: 1rem;
      background: transparent;
      color: #374151;
      resize: none;
      min-height: 20px;
      max-height: 120px;
      overflow-y: hidden;
      line-height: 1.5;
      font-family: inherit;
    }

    .message-input::placeholder {
      color: #9ca3af;
    }

    .send-button {
      width: 44px;
      height: 44px;
      background: #FF7F7F;
      border: none;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
      align-self: flex-end;
      margin-bottom: 4px;
    }

    .send-button:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(255, 127, 127, 0.4);
      background: #FF6B6B;
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .welcome-message {
      text-align: center;
      color: #6b7280;
      margin: 40px 0;
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .welcome-message h3 {
      font-size: 1.2rem;
      margin-bottom: 8px;
      color: #374151;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 20px;
    }

    .quick-action {
      padding: 10px 12px;
      background: rgba(255, 127, 127, 0.1);
      border: 1px solid rgba(255, 127, 127, 0.2);
      border-radius: 12px;
      cursor: pointer;
      text-align: center;
      font-size: 0.85rem;
      color: #FF7F7F;
      transition: all 0.2s ease;
    }

    .quick-action:hover {
      background: rgba(255, 127, 127, 0.2);
      transform: translateY(-1px);
    }

    .error-message {
      background: #fee2e2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    /* Mobile responsive */
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      .chat-container {
        max-width: 100%;
        height: calc(100vh - 20px);
        border-radius: 20px;
      }
    }
  
    .message-bubble h1, 
    .message-bubble h2, 
    .message-bubble h3 {
      margin: 6px 0;
      font-weight: 600;
    }

    .message-bubble p {
      margin: 6px 0;
    }

    .message-bubble ul, 
    .message-bubble ol {
      margin: 6px 0 6px 20px;
      padding-left: 20px;
    }

    .message-bubble li {
      margin-bottom: 4px;
    }

    .message-bubble strong {
      font-weight: 600;
      color: #111827;
    }

    .message-bubble a {
      color: #2563eb;
      text-decoration: underline;
    }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="chat-container">
    <div class="header">
      <div class="status-indicator"></div>
      <h1>😼 Finn</h1>
      <p>Your Personal Student Financial Advisor</p>
    </div>

    <div class="chat-messages" id="chatMessages">
      <div class="welcome-message">
        <h3>👋 Welcome!</h3>
        <p>I am Finn, your AI-powered financial advisor designed specifically for you! I can help with budgeting, saving, investing, and finding ways to earn money as a student.</p>
        
        <div class="quick-actions">
          <div class="quick-action" onclick="sendQuickMessage('How should I budget as a student?')">
            💳 Budgeting Tips
          </div>
          <div class="quick-action" onclick="sendQuickMessage('What are the best ways to save money?')">
            💰 Saving Strategies
          </div>
          <div class="quick-action" onclick="sendQuickMessage('How can I manage my student loans?')">
            🎓 Student Loans
          </div>
          <div class="quick-action" onclick="sendQuickMessage('What side jobs are good for students?')">
            💼 Side Hustles
          </div>
        </div>
      </div>
    </div>

    <div class="typing-indicator" id="typingIndicator">
      <div class="bot-avatar">🙀</div>
      <div class="typing-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>

    <div class="input-area">
      <div class="input-container">
        <textarea 
          class="message-input" 
          id="messageInput" 
          placeholder="Ask me anything about student finances..."
          rows="1"
        ></textarea>
        <button class="send-button" id="sendButton" onclick="sendMessage()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    class FinanceChatbot {
      constructor() {
        this.messagesContainer = document.getElementById('chatMessages');
        this.messageInput = document.getElementById('messageInput');
        this.sendButton = document.getElementById('sendButton');
        this.typingIndicator = document.getElementById('typingIndicator');
        
        this.setupEventListeners();
        this.initializeInput();
      }

      initializeInput() {
        // Set initial height
        this.resizeInput();
      }

      setupEventListeners() {
        // Send message on Enter key (but allow Shift+Enter for new lines)
        this.messageInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            this.sendMessage();
          }
        });

        // Enhanced auto-resize functionality
        this.messageInput.addEventListener('input', (e) => {
          this.resizeInput();
        });

        // Also resize on paste
        this.messageInput.addEventListener('paste', (e) => {
          setTimeout(() => this.resizeInput(), 0);
        });
      }

      resizeInput() {
        const input = this.messageInput;
        
        // Reset height to auto to get the actual scrollHeight
        input.style.height = 'auto';
        
        // Calculate the new height
        const scrollHeight = input.scrollHeight;
        const lineHeight = parseInt(window.getComputedStyle(input).lineHeight);
        const padding = 24; // 12px top + 12px bottom padding
        const minHeight = lineHeight + padding;
        const maxHeight = 120; // Your existing max height
        
        // Set the new height
        const newHeight = Math.min(Math.max(scrollHeight, minHeight), maxHeight);
        input.style.height = newHeight + 'px';
        
        // Show scrollbar if content exceeds max height
        if (scrollHeight > maxHeight) {
          input.style.overflowY = 'auto';
        } else {
          input.style.overflowY = 'hidden';
        }
      }

      async sendMessage() {
        const message = this.messageInput.value.trim();
        if (!message || this.sendButton.disabled) return;

        // Add user message
        this.addMessage(message, 'user');
        
        // Clear input and reset height
        this.messageInput.value = '';
        this.resizeInput();
        this.setSendButtonState(false);

        // Show typing indicator
        this.showTypingIndicator();

        try {
          // Get bot response (replace this with your LLM API call)
          const response = await this.getBotResponse(message);
          this.addMessage(response, 'bot');
        } catch (error) {
          console.error('Error getting bot response:', error);
          this.addMessage('Sorry, I encountered an error. Please try again.', 'bot', true);
        } finally {
          this.hideTypingIndicator();
          this.setSendButtonState(true);
        }
      }

      addMessage(text, sender, isError = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;

        if (sender === 'bot') {
          const avatar = document.createElement('div');
          avatar.className = 'bot-avatar';
          avatar.textContent = '🤖';
          messageDiv.appendChild(avatar);
        }

        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${isError ? 'error-message' : ''}`;
        bubble.innerHTML = marked.parse(text);
        messageDiv.appendChild(bubble);

        this.messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();

        // Hide welcome message after first interaction
        const welcomeMessage = document.querySelector('.welcome-message');
        if (welcomeMessage) {
          welcomeMessage.style.display = 'none';
        }
      }

      async getBotResponse(message) {
        try {
          const response = await fetch("http://8.219.232.48/v1/chat-messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer app-SH2zUXIllSpQjY9kdvvlxPHr" // replace with your Dify API key
            },
            body: JSON.stringify({
              inputs: {},         // you can pass extra context here if needed
              query: message,     // the user's message
              response_mode: "blocking", 
              user: "student"     // optional identifier for the user
            })
          });

          if (!response.ok) {
            throw new Error("Failed to get response from Dify server");
          }

          const data = await response.json();

          // Dify usually returns the model's reply under data.answer
          return data.answer || "Sorry, I didn't get a response.";
        } catch (error) {
          console.error("Error calling Dify API:", error);
          return "⚠️ Sorry, something went wrong while connecting to the AI server.";
        }
      }

      showTypingIndicator() {
        this.typingIndicator.style.display = 'flex';
        this.scrollToBottom();
      }

      hideTypingIndicator() {
        this.typingIndicator.style.display = 'none';
      }

      setSendButtonState(enabled) {
        this.sendButton.disabled = !enabled;
      }

      scrollToBottom() {
        setTimeout(() => {
          this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
        }, 100);
      }

      delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }
    }

    // Initialize chatbot
    const chatbot = new FinanceChatbot();

    // Quick action function
    function sendQuickMessage(message) {
      document.getElementById('messageInput').value = message;
      chatbot.resizeInput(); // Resize after setting the value
      chatbot.sendMessage();
    }

    // Global function for the send button
    function sendMessage() {
      chatbot.sendMessage();
    }
  </script>
</body>
</html>